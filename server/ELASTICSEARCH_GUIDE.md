# üîç Elasticsearch Guide

## üìã –û–±–∑–æ—Ä

Elasticsearch –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞, –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

## üöÄ –ó–∞–ø—É—Å–∫

### 1. –ß–µ—Ä–µ–∑ Docker Compose
```bash
cd server
docker-compose up -d elasticsearch kibana
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
# Elasticsearch
curl http://localhost:9200/_cluster/health

# Kibana
http://localhost:5601
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```env
ELASTICSEARCH_NODE=http://localhost:9200
ELASTICSEARCH_USERNAME=elastic
ELASTICSEARCH_PASSWORD=changeme
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω–¥–µ–∫—Å–∞
- **–ù–∞–∑–≤–∞–Ω–∏–µ**: `comments`
- **–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä**: `standard` —Å —Ä—É—Å—Å–∫–∏–º–∏ —Å—Ç–æ–ø-—Å–ª–æ–≤–∞–º–∏
- **–¢–∏–ø—ã –ø–æ–ª–µ–π**: text, keyword, date, integer

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–Ω–¥–µ–∫—Å–∞

### –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π
```json
{
  "mappings": {
    "properties": {
      "id": { "type": "keyword" },
      "author": { 
        "type": "text",
        "analyzer": "standard",
        "fields": {
          "keyword": { "type": "keyword" }
        }
      },
      "content": { 
        "type": "text",
        "analyzer": "standard",
        "fields": {
          "keyword": { "type": "keyword" }
        }
      },
      "homepage": { 
        "type": "text",
        "analyzer": "standard",
        "fields": {
          "keyword": { "type": "keyword" }
        }
      },
      "timestamp": { "type": "date" },
      "level": { "type": "integer" },
      "parent_id": { "type": "keyword" },
      "created_at": { "type": "date" },
      "updated_at": { "type": "date" }
    }
  }
}
```

## üîç –ü–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã

### 1. –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
```graphql
query {
  searchComments(query: "–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ", filters: { level: 0 }) {
    id
    author
    content
    score
    highlight {
      content
      author
    }
  }
}
```

### 2. –ü–æ–∏—Å–∫ –ø–æ –∞–≤—Ç–æ—Ä—É
```graphql
query {
  searchByAuthor(author: "John Doe") {
    id
    author
    content
    timestamp
  }
}
```

### 3. –ü–æ–∏—Å–∫ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
```graphql
query {
  searchByContent(content: "–æ—Ç–ª–∏—á–Ω—ã–π –ø–æ—Å—Ç") {
    id
    author
    content
    score
  }
}
```

### 4. –ü–æ–∏—Å–∫ –ø–æ HomePage
```graphql
query {
  searchByHomepage(homepage: "johndoe") {
    id
    author
    content
    homepage
  }
}
```

### 5. –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
```graphql
query {
  getSuggestions(query: "jo") {
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
  }
}
```

## üéØ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø–æ–ª–µ–π
- **content**: –≤–µ—Å 3 (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- **author**: –≤–µ—Å 2 (—Å—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- **homepage**: –≤–µ—Å 1 (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

### –ù–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫
- –ü–æ–∏—Å–∫ –ø–æ —Å–∏–Ω–æ–Ω–∏–º–∞–º
- –£—á–µ—Ç –º–æ—Ä—Ñ–æ–ª–æ–≥–∏–∏ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
- –ü–æ —É—Ä–æ–≤–Ω—é –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ (`level`)
- –ü–æ –∞–≤—Ç–æ—Ä—É (`author`)
- –ü–æ HomePage (`homepage`)

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Kibana Dashboard
- **URL**: http://localhost:5601
- **–ò–Ω–¥–µ–∫—Å**: `comments`
- **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏**: –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∞–≤—Ç–æ—Ä—ã, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

### Elasticsearch API
```bash
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω–¥–µ–∫—Å–∞
curl http://localhost:9200/comments/_stats

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
curl http://localhost:9200/comments/_count

# –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞
curl -X POST "localhost:9200/comments/_analyze" \
  -H 'Content-Type: application/json' \
  -d '{
    "analyzer": "standard",
    "text": "–û—Ç–ª–∏—á–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π!"
  }'
```

## üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è

### Bulk –æ–ø–µ—Ä–∞—Ü–∏–∏
```typescript
// –ú–∞—Å—Å–æ–≤–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
await elasticsearchService.bulkIndex(comments);
```

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
- –ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Elasticsearch
- –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ PostgreSQL
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –°—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–º
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
curl -X PUT "localhost:9200/comments"

# –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
curl -X DELETE "localhost:9200/comments"

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
curl -X POST "localhost:9200/comments/_refresh"
```

### –ü–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
```bash
# –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫
curl -X GET "localhost:9200/comments/_search?q=content:–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ"

# –°–ª–æ–∂–Ω—ã–π –ø–æ–∏—Å–∫
curl -X POST "localhost:9200/comments/_search" \
  -H 'Content-Type: application/json' \
  -d '{
    "query": {
      "multi_match": {
        "query": "–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ",
        "fields": ["content^3", "author^2"]
      }
    }
  }'
```

## üéØ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ bulk –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –º–∞–ø–ø–∏–Ω–≥–∏
- –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –∏–Ω–¥–µ–∫—Å—ã

### 2. –ü–æ–∏—Å–∫
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–∞
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Elasticsearch Documentation](https://www.elastic.co/guide/index.html)
- [NestJS Elasticsearch](https://docs.nestjs.com/techniques/elasticsearch)
- [Elasticsearch Query DSL](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html)
